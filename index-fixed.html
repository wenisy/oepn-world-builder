<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简易体素游戏</title>
    <style>
        body { margin: 0; overflow: hidden; }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            z-index: 100;
        }
        #crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin-top: -10px;
            margin-left: -10px;
            color: white;
            font-size: 20px;
            text-align: center;
            pointer-events: none;
            user-select: none;
        }
    </style>
</head>
<body>
    <div id="info">
        <h2>简易体素游戏</h2>
        <p>WASD移动，空格跳跃，鼠标控制视角</p>
        <p>点击画布锁定鼠标，ESC解锁</p>
        <p>位置: <span id="position">0, 0, 0</span></p>
        <p>FPS: <span id="fps">0</span></p>
    </div>
    <div id="crosshair">+</div>
    
    <!-- 直接使用脚本标签加载 Three.js 库 -->
    <script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.158.0/examples/js/controls/PointerLockControls.js"></script>
    
    <script>
        // 简易体素游戏
        class SimpleVoxelGame {
            constructor() {
                // 初始化场景
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x87CEEB);
                this.scene.fog = new THREE.Fog(0x87CEEB, 100, 500);
                
                // 初始化相机
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                this.camera.position.set(0, 10, 0);
                
                // 初始化渲染器
                this.renderer = new THREE.WebGLRenderer({ antialias: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(window.devicePixelRatio);
                this.renderer.shadowMap.enabled = true;
                document.body.appendChild(this.renderer.domElement);
                
                // 添加光源
                this.setupLights();
                
                // 初始化控制器
                this.controls = new THREE.PointerLockControls(this.camera, this.renderer.domElement);
                
                // 点击画布锁定鼠标
                this.renderer.domElement.addEventListener('click', () => {
                    this.controls.lock();
                });
                
                // 监听锁定状态变化
                this.controls.addEventListener('lock', () => {
                    console.log('鼠标已锁定');
                });
                
                this.controls.addEventListener('unlock', () => {
                    console.log('鼠标已解锁');
                });
                
                // 玩家状态
                this.player = {
                    velocity: new THREE.Vector3(),
                    onGround: false,
                    speed: 10,
                    jumpStrength: 15,
                    gravity: 30
                };
                
                // 输入状态
                this.keys = {
                    forward: false,
                    backward: false,
                    left: false,
                    right: false,
                    jump: false
                };
                
                // 添加键盘事件监听
                document.addEventListener('keydown', this.onKeyDown.bind(this));
                document.addEventListener('keyup', this.onKeyUp.bind(this));
                
                // 生成地形
                this.generateTerrain();
                
                // 性能监控
                this.stats = {
                    fps: 0,
                    frameCount: 0,
                    lastTime: performance.now()
                };
                
                // 时间相关
                this.clock = new THREE.Clock();
                
                // 开始动画循环
                this.animate();
            }
            
            // 设置光照
            setupLights() {
                // 环境光
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                this.scene.add(ambientLight);
                
                // 定向光（模拟太阳）
                const sunLight = new THREE.DirectionalLight(0xffffff, 0.8);
                sunLight.position.set(100, 100, 50);
                sunLight.castShadow = true;
                
                // 设置阴影参数
                sunLight.shadow.mapSize.width = 2048;
                sunLight.shadow.mapSize.height = 2048;
                sunLight.shadow.camera.near = 0.5;
                sunLight.shadow.camera.far = 500;
                sunLight.shadow.camera.left = -100;
                sunLight.shadow.camera.right = 100;
                sunLight.shadow.camera.top = 100;
                sunLight.shadow.camera.bottom = -100;
                
                this.scene.add(sunLight);
            }
            
            // 生成地形
            generateTerrain() {
                // 创建地面
                const groundGeometry = new THREE.BoxGeometry(100, 2, 100);
                const groundMaterial = new THREE.MeshStandardMaterial({ color: 0x3d8c40 });
                const ground = new THREE.Mesh(groundGeometry, groundMaterial);
                ground.position.y = -1;
                ground.receiveShadow = true;
                this.scene.add(ground);
                
                // 创建一些随机方块
                const blockGeometry = new THREE.BoxGeometry(1, 1, 1);
                const blockMaterial = new THREE.MeshStandardMaterial({ color: 0x8b4513 });
                
                for (let i = 0; i < 100; i++) {
                    const block = new THREE.Mesh(blockGeometry, blockMaterial);
                    block.position.set(
                        Math.floor(Math.random() * 80 - 40),
                        0,
                        Math.floor(Math.random() * 80 - 40)
                    );
                    block.castShadow = true;
                    block.receiveShadow = true;
                    this.scene.add(block);
                }
                
                // 添加一些高度变化
                for (let i = 0; i < 20; i++) {
                    const height = Math.floor(Math.random() * 5) + 1;
                    const width = Math.floor(Math.random() * 3) + 1;
                    const depth = Math.floor(Math.random() * 3) + 1;
                    
                    const blockGeometry = new THREE.BoxGeometry(width, height, depth);
                    const block = new THREE.Mesh(blockGeometry, blockMaterial);
                    
                    block.position.set(
                        Math.floor(Math.random() * 80 - 40),
                        height / 2,
                        Math.floor(Math.random() * 80 - 40)
                    );
                    
                    block.castShadow = true;
                    block.receiveShadow = true;
                    this.scene.add(block);
                }
            }
            
            // 键盘按下事件
            onKeyDown(event) {
                if (!this.controls.isLocked) return;
                
                switch (event.code) {
                    case 'KeyW':
                        this.keys.forward = true;
                        break;
                    case 'KeyS':
                        this.keys.backward = true;
                        break;
                    case 'KeyA':
                        this.keys.left = true;
                        break;
                    case 'KeyD':
                        this.keys.right = true;
                        break;
                    case 'Space':
                        this.keys.jump = true;
                        break;
                }
            }
            
            // 键盘松开事件
            onKeyUp(event) {
                switch (event.code) {
                    case 'KeyW':
                        this.keys.forward = false;
                        break;
                    case 'KeyS':
                        this.keys.backward = false;
                        break;
                    case 'KeyA':
                        this.keys.left = false;
                        break;
                    case 'KeyD':
                        this.keys.right = false;
                        break;
                    case 'Space':
                        this.keys.jump = false;
                        break;
                }
            }
            
            // 更新玩家
            updatePlayer(deltaTime) {
                // 应用重力
                this.player.velocity.y -= this.player.gravity * deltaTime;
                
                // 模拟地面碰撞
                if (this.camera.position.y < 1) {
                    this.player.velocity.y = 0;
                    this.camera.position.y = 1;
                    this.player.onGround = true;
                } else {
                    this.player.onGround = false;
                }
                
                // 处理跳跃
                if (this.keys.jump && this.player.onGround) {
                    this.player.velocity.y = this.player.jumpStrength;
                }
                
                // 计算移动方向
                const direction = new THREE.Vector3();
                
                if (this.keys.forward) direction.z -= 1;
                if (this.keys.backward) direction.z += 1;
                if (this.keys.left) direction.x -= 1;
                if (this.keys.right) direction.x += 1;
                
                // 如果有移动输入
                if (direction.length() > 0) {
                    // 归一化方向向量
                    direction.normalize();
                    
                    // 获取相机方向
                    const cameraDirection = new THREE.Vector3();
                    this.camera.getWorldDirection(cameraDirection);
                    cameraDirection.y = 0;
                    cameraDirection.normalize();
                    
                    // 计算相机右方向
                    const cameraRight = new THREE.Vector3(
                        cameraDirection.z,
                        0,
                        -cameraDirection.x
                    );
                    
                    // 计算最终移动方向
                    const moveDirection = new THREE.Vector3();
                    moveDirection.addScaledVector(cameraDirection, direction.z);
                    moveDirection.addScaledVector(cameraRight, direction.x);
                    moveDirection.normalize();
                    
                    // 应用移动
                    this.camera.position.x += moveDirection.x * this.player.speed * deltaTime;
                    this.camera.position.z += moveDirection.z * this.player.speed * deltaTime;
                }
                
                // 应用垂直速度
                this.camera.position.y += this.player.velocity.y * deltaTime;
                
                // 限制玩家不会掉出世界
                if (this.camera.position.y < -10) {
                    this.camera.position.set(0, 10, 0);
                    this.player.velocity.set(0, 0, 0);
                }
            }
            
            // 动画循环
            animate() {
                requestAnimationFrame(this.animate.bind(this));
                
                // 计算时间增量
                const deltaTime = this.clock.getDelta();
                
                // 更新玩家
                this.updatePlayer(deltaTime);
                
                // 更新FPS计数
                const now = performance.now();
                this.stats.frameCount++;
                
                if (now - this.stats.lastTime >= 1000) {
                    this.stats.fps = this.stats.frameCount;
                    this.stats.frameCount = 0;
                    this.stats.lastTime = now;
                    
                    // 更新UI
                    document.getElementById('fps').textContent = this.stats.fps;
                }
                
                // 更新位置信息
                document.getElementById('position').textContent = `${Math.floor(this.camera.position.x)}, ${Math.floor(this.camera.position.y)}, ${Math.floor(this.camera.position.z)}`;
                
                // 渲染场景
                this.renderer.render(this.scene, this.camera);
            }
        }
        
        // 创建游戏实例
        const game = new SimpleVoxelGame();
        
        // 处理窗口大小变化
        window.addEventListener('resize', () => {
            game.camera.aspect = window.innerWidth / window.innerHeight;
            game.camera.updateProjectionMatrix();
            game.renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
