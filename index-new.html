<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>开放世界建设者</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #000;
        }
        
        #game-container {
            position: relative;
            width: 100%;
            height: 100vh;
        }
        
        #game-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        #loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .loading-content {
            text-align: center;
            color: #fff;
        }
        
        .loading-content h1 {
            font-size: 2rem;
            margin-bottom: 1rem;
        }
        
        .progress-bar {
            width: 300px;
            height: 20px;
            background-color: #333;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px auto;
        }
        
        .progress {
            width: 0%;
            height: 100%;
            background-color: #4CAF50;
            transition: width 0.3s;
        }
        
        #ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: none;
        }
        
        #ui-overlay.visible {
            display: block;
        }
        
        #top-menu {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            pointer-events: auto;
        }
    </style>
</head>
<body>
    <!-- 游戏容器 -->
    <div id="game-container">
        <canvas id="game-canvas"></canvas>

        <!-- UI覆盖层 -->
        <div id="ui-overlay">
            <!-- 顶部菜单 -->
            <div id="top-menu">
                <div id="player-info">
                    <span id="player-name">玩家</span>
                    <span id="player-resources">资源: 100</span>
                </div>
                <div id="game-controls">
                    <button id="build-button">建造</button>
                    <button id="social-button">社交</button>
                    <button id="settings-button">设置</button>
                </div>
            </div>
        </div>

        <!-- 加载屏幕 -->
        <div id="loading-screen">
            <div class="loading-content">
                <h1>开放世界建设者</h1>
                <div class="progress-bar">
                    <div class="progress"></div>
                </div>
                <p class="loading-text">正在加载游戏资源...</p>
                <button id="debug-start" style="margin-top: 20px; padding: 10px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">手动开始游戏</button>
            </div>
        </div>
    </div>

    <!-- 脚本 -->
    <script type="module">
        import * as THREE from 'https://unpkg.com/three@0.158.0/build/three.module.js';
        
        // 游戏是否已经初始化
        let gameInitialized = false;
        
        // 添加全局调试函数
        window.hideLoadingScreen = function() {
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) {
                loadingScreen.style.display = 'none';
                console.log('已手动隐藏加载屏幕');
            }
        };
        
        window.showLoadingScreen = function() {
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) {
                loadingScreen.style.display = 'flex';
                console.log('已手动显示加载屏幕');
            }
        };
        
        // 更新加载进度
        function updateLoadingProgress(percent, message) {
            console.log(`更新加载进度: ${percent}%, ${message}`);
            
            const progressBar = document.querySelector('.progress');
            const loadingText = document.querySelector('.loading-text');
            
            if (progressBar) {
                progressBar.style.width = `${percent}%`;
            }
            
            if (loadingText && message) {
                loadingText.textContent = message;
            }
        }
        
        // 初始化游戏
        function initGame() {
            // 防止重复初始化
            if (gameInitialized) {
                console.log('游戏已经初始化，跳过');
                return;
            }
            
            console.log('开始初始化游戏...');
            gameInitialized = true;
            
            // 更新加载进度
            updateLoadingProgress(10, '初始化场景...');
            
            // 创建场景
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            
            // 更新加载进度
            updateLoadingProgress(20, '初始化相机...');
            
            // 创建相机
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 10);
            
            // 更新加载进度
            updateLoadingProgress(30, '初始化渲染器...');
            
            // 创建渲染器
            const renderer = new THREE.WebGLRenderer({
                canvas: document.getElementById('game-canvas'),
                antialias: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            
            // 更新加载进度
            updateLoadingProgress(50, '添加光源...');
            
            // 添加光源
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 10, 10);
            scene.add(directionalLight);
            
            // 更新加载进度
            updateLoadingProgress(70, '创建游戏对象...');
            
            // 添加一个立方体
            const geometry = new THREE.BoxGeometry(2, 2, 2);
            const material = new THREE.MeshStandardMaterial({ color: 0x00ff00 });
            const cube = new THREE.Mesh(geometry, material);
            scene.add(cube);
            
            // 更新加载进度
            updateLoadingProgress(80, '创建地形...');
            
            // 添加地面
            const planeGeometry = new THREE.PlaneGeometry(20, 20);
            const planeMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xaaaaaa,
                side: THREE.DoubleSide
            });
            const plane = new THREE.Mesh(planeGeometry, planeMaterial);
            plane.rotation.x = Math.PI / 2;
            plane.position.y = -1;
            scene.add(plane);
            
            // 动画循环
            function animate() {
                requestAnimationFrame(animate);
                
                // 旋转立方体
                cube.rotation.x += 0.01;
                cube.rotation.y += 0.01;
                
                // 渲染场景
                renderer.render(scene, camera);
            }
            
            // 处理窗口大小变化
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
            
            // 更新加载进度到100%
            updateLoadingProgress(100, '加载完成!');
            
            // 延迟一秒后隐藏加载屏幕，让用户看到进度条完成
            setTimeout(() => {
                try {
                    const loadingScreen = document.getElementById('loading-screen');
                    if (loadingScreen) {
                        console.log('隐藏加载屏幕');
                        loadingScreen.style.display = 'none';
                        
                        // 显示UI
                        document.getElementById('ui-overlay').classList.add('visible');
                    } else {
                        console.error('找不到加载屏幕元素');
                    }
                } catch (error) {
                    console.error('隐藏加载屏幕时出错:', error);
                }
            }, 1000);
            
            // 开始动画
            animate();
        }
        
        // 页面加载完成后初始化游戏
        window.addEventListener('load', () => {
            console.log('页面加载完成');
            
            // 添加调试按钮的事件监听器
            const debugButton = document.getElementById('debug-start');
            if (debugButton) {
                debugButton.addEventListener('click', () => {
                    console.log('点击了手动开始游戏按钮');
                    
                    // 如果游戏已经初始化，直接隐藏加载屏幕
                    if (gameInitialized) {
                        console.log('游戏已初始化，直接隐藏加载屏幕');
                        const loadingScreen = document.getElementById('loading-screen');
                        if (loadingScreen) {
                            loadingScreen.style.display = 'none';
                            
                            // 显示UI
                            document.getElementById('ui-overlay').classList.add('visible');
                        }
                    } else {
                        // 否则初始化游戏
                        initGame();
                    }
                });
                console.log('添加了调试按钮的事件监听器');
            }
            
            // 等待一秒后初始化游戏，确保 DOM 完全加载
            setTimeout(initGame, 1000);
        });
    </script>
</body>
</html>
